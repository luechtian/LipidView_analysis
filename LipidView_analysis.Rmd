---
title: "Tidy lipidomics data"
output:
  html_document:
    df_print: paged
params:
  input_folder: AMV
  output_folder: ./
  metadata_name: metadata
---

# Load packages

```{r tidyverse and janitor, message=FALSE}
library(tidyverse)
library(janitor)
```

# Import data

```{r Import meta and LV data, message=FALSE, warning=FALSE}
# Paths
input_folder <- params$input_folder
output_folder <- params$output_folder
metadata_name <- params$metadata_name

# Import meta data
meta_data <- read.csv(list.files(path = input_folder, pattern = metadata_name, full.names = T)) %>% 
  clean_names()

# List all (LipidView) txt.files in designated input_folder
files <- list.files(path = input_folder, pattern = ".txt", full.names = TRUE) 

# Parse lipid class from file names
splitted_files <- str_split(files, pattern = "_", simplify = TRUE)
names(files) <- str_replace_all(splitted_files[,ncol(splitted_files)],".txt", "")

# Read and merge all LipidView txt.files
raw_data <- map_df(files, read_tsv, skip = 1, .id = "class") %>% 
  clean_names()
  
```

# Prepare data for arithmetic operations

## Prepare LipidView data

```{r clean and prepare LipidView files}
# General clean up of the LipidView dataframe:
## Get rid off unnecessary columns and strings, rename columns
raw_data <- raw_data %>%
  filter(!str_detect(sample_name, "Sample ID")) %>% 
  select(-sample_name, -x2, -x3, -x4) %>% 
  rename("species" = x5,
         "scan_name"= x6) %>% 
  pivot_longer(
    cols = c(-species, -class, -scan_name),
    names_to = "samples",
    values_to = "intensity") %>% 
  mutate(species = str_remove(species, "\\+NH4"))

# Extract the intensities of internal standards and return the mean of IS-intensities to the rawdata
is_data <- raw_data %>% 
  filter(str_detect(species, "IS"),
         class != "TAG") %>% 
  group_by(class, samples) %>% 
  summarise(is_intensity = mean(intensity))

# Special case for TAG
# Because "IS D5-TAG 17:0/17:1/17:0" is the only internal standard for TAG quantification in use, it is for now filtered by hardcode
is_tag_data <- raw_data %>% 
  filter(str_detect(species, "IS"),
         species == "IS D5-TAG 17:0/17:1/17:0",
         str_detect(scan_name, "17:0")) %>% 
  select(class, samples, is_intensity = intensity)

is_data <- full_join(is_data, is_tag_data, by = c("class", "samples", "is_intensity"))
```

## Prepare meta data

```{r clean and prepare metadata}
# Extract sample input [ul] from meta data
sample_input <- meta_data %>%
  filter(str_detect(class, "sample input")) %>% 
  select(-class, -rf_values, -x) %>%
  pivot_longer(everything(),
               names_to = "samples",
               values_to = "sample_input")


# Extract internal standard concentrations [pmol]
# and response factors (rf-values) from meta data
standard_input <- meta_data %>%
  filter(!str_detect(class, "sample input")) %>% 
  select(-x) %>%
  pivot_longer(
    cols = c(-class, -rf_values),
    names_to = "samples",
    values_to = "standard_input")

```

## Join them all

```{r bring all data together, message=FALSE, warning=FALSE}
# Join data and get rid off redundant columns (scan_name) and observations (IS rows)
joined_data <- raw_data %>% 
  left_join(is_data, by = c("class", "samples")) %>% 
  left_join(standard_input, by = c("class", "samples")) %>% 
  left_join(sample_input, by = "samples") %>% 
  select(-scan_name) %>% 
  filter(!str_detect(species, "IS"))
```

## Special cases

Before the script can proceed with number crunching, there are some special cases to deal with. Those are classes without predetermined rf_values (e.g. Cholesterol & Ergosterol) and classes with identical species from different scans(e.g. neutral loss-scans of fatty acids in DAG & TAG) 

Tasks:

- classes without predetermined rf_values: Calculate the rf-value with kon_b and kon_c

- classes with identical species from different scans: Sum DAG/TAG-species with the same fatty acid sum, but different fatty acid composition. 
  - Better way is to calculate the possible sum of detected fatty acids in neutral loss-scans.
  - But for now, simple sums of the same DAG- and TAG-species (FA_sum) are sufficient.

#### classes without predetermined rf_values

```{r Calc missing rf-values}
if (any(joined_data$rf_values) == TRUE){
  
  # Calculate pmol-values of kon_a, _b and _c
  missing_rf <- joined_data %>%
    filter(str_detect(samples, "kon") & is.na(rf_values)) %>% 
    mutate(pmol = (standard_input/is_intensity * intensity))
  
  # add new column with pmol-values of kon_a for blank substraction and 
  missing_rf <- left_join(missing_rf, missing_rf[missing_rf$samples == "kon_a",c("class", "species", "pmol")], by = c("class", "species")) %>% 
    mutate(pmol = sample_input/(pmol.x - pmol.y)) %>% 
    filter(!str_detect(samples, "kon_a")) %>% 
    group_by(class, species) %>% 
    summarise(rf_values = mean(pmol))
  
  # join and unite the calculated rf-values and get rid off kon_b and c.
  ##unite()-function merges 2 columns and returns characters. Therefore remove NA-strings and convert back to numeric)  
   left_join(joined_data, missing_rf, by = c("class", "species")) %>% 
    unite("rf_values","rf_values.y","rf_values.x", sep = "_", remove = TRUE, na.rm = TRUE) %>% 
    mutate(rf_values = str_remove(rf_values, "_NA"),
           rf_values = str_remove(rf_values, "NA_"),
           rf_values = as.numeric(rf_values)) %>% 
    filter(!(samples %in% c("kon_b", "kon_c")))
 
}
```











