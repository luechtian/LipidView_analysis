---
title: "LipidView Analysis"
output:
  html_document:
    df_print: paged
params:
  input_folder: AMV
  output_folder: ./
  metadata_name: metadata
editor_options: 
  chunk_output_type: inline
---

# Load packages

```{r Tidyverse and janitor, message=FALSE}
library(tidyverse)
library(janitor)
library(openxlsx)
```

# Import data

```{r Import meta and LV data, message=FALSE, warning=FALSE}
# Paths
input_folder <- params$input_folder
output_folder <- params$output_folder
metadata_name <- params$metadata_name

# Import meta data
meta_data <- read.csv(list.files(path = input_folder, pattern = metadata_name, full.names = T)) %>% 
  clean_names()

# List all (LipidView) txt.files in designated input_folder
files <- list.files(path = input_folder, pattern = ".txt", full.names = TRUE)

# Parse lipid class from file names
splitted_files <- str_split(files, pattern = "_", simplify = TRUE)
names(files) <- str_remove_all(splitted_files[, ncol(splitted_files)],".txt")

# Read and merge all LipidView txt.files
raw_df <- map_df(files, read_tsv, skip = 1, .id = "class") %>% 
  clean_names()
```

# Prepare data for arithmetic operations

## Prepare LipidView data

```{r Clean and prepare LipidView files}
# General clean up of the LipidView dataframe:
## Get rid off unnecessary columns and strings, rename columns
raw_data <- raw_df %>%
  filter(!str_detect(sample_name, "Sample ID")) %>% 
  select(-sample_name, -x2, -x3, -x4, -x6) %>% 
  rename("species" = x5) %>% 
  pivot_longer(
    cols = c(-species, -class),
    names_to = "samples",
    values_to = "intensity") %>%
  mutate(species = str_remove_all(species, "\\+NH4"))

# Extract the intensities of internal standards and return the mean of IS-intensities to the rawdata
is_data <- raw_data %>% 
  filter(str_detect(species, "IS"),
         class != "TAG") %>% 
  group_by(class, samples) %>% 
  summarise(is_intensity = mean(intensity))

# Special case for TAG
# Because "IS D5-TAG 17:0/17:1/17:0" is the only internal standard for TAG quantification in use, it is filtered by hardcode for now.
is_data <- raw_data %>% 
  filter(str_detect(species, "IS"),
         species == "IS D5-TAG 17:0/17:1/17:0") %>% 
  group_by(class, samples) %>% 
  summarise(is_intensity = sum(intensity)) %>% 
  full_join(is_data, by = c("class", "samples", "is_intensity"))
```

## Prepare meta data

```{r Clean and prepare metadata}
# Extract sample input [ul] from meta data
sample_input <- meta_data %>%
  filter(class == "sample input") %>% 
  select(-class, -rf_values, -x) %>%
  pivot_longer(everything(),
               names_to = "samples",
               values_to = "sample_input")

# Extract internal standard concentrations [pmol]
# and response factors (rf-values) from meta data
standard_input <- meta_data %>%
  filter(class != "sample input") %>% 
  select(-x) %>%
  pivot_longer(
    cols = c(-class, -rf_values),
    names_to = "samples",
    values_to = "standard_input")
```

## Join them all

```{r Bring all data together, message=FALSE, warning=FALSE}
# Join data and get rid off redundant columns (scan_name) and observations (IS rows)
joined_data <- raw_data %>% 
  left_join(is_data, by = c("class", "samples")) %>% 
  left_join(standard_input, by = c("class", "samples")) %>% 
  left_join(sample_input, by = "samples") %>% 
  filter(!str_detect(species, "IS"))
```

## Special cases

Before the script can proceed with number crunching, there are some special cases to deal with. Those are classes without predetermined rf_values (e.g. Cholesterol & Ergosterol) and classes with identical species from different scans(e.g. neutral loss-scans of fatty acids in DAG & TAG) 

Tasks:

- classes without predetermined rf_values: Calculate the rf-value with kon_b and kon_c

- classes with identical species from different scans: Sum DAG/TAG-species with the same fatty acid sum, but different fatty acid composition. 
  - Better way is to calculate the possible sum of detected fatty acids in neutral loss-scans.
  - But for now, simple sums of the same DAG- and TAG-species (FA_sum) are sufficient.

#### Classes without predetermined rf_values

```{r Calc missing rf-values, message=FALSE, warning=FALSE}
if (any(is.na(joined_data$rf_values)) == TRUE){
  
  # Calculate pmol-values of kon_a, _b and _c
  missing_rf <- joined_data %>%
    filter(str_detect(samples, "kon") & is.na(rf_values)) %>% 
    mutate(pmol = (standard_input/is_intensity * intensity))
  
  # create kon_a variable for better reading
  kon_a <- missing_rf %>% 
    filter(samples == "kon_a") %>%  
    select(class, species, kon_a_pmol = pmol)

  # add new column with pmol-values of kon_a for blank substraction and 
  missing_rf <- left_join(missing_rf, kon_a, by = c("class", "species")) %>% 
    mutate(rf_values = sample_input/(pmol - kon_a_pmol)) %>% 
    filter(!str_detect(samples, "kon_a")) %>% 
    group_by(class, species) %>% 
    summarise(rf_values = mean(rf_values))
  
  # join and unite the calculated rf-values and get rid off kon_b and c.
  ##unite()-function merges 2 columns and returns characters. Therefore remove NA-strings and convert back to numeric)  
   joined_data <- left_join(joined_data, missing_rf, by = c("class", "species")) %>% 
    unite("rf_values","rf_values.y","rf_values.x", sep = "", remove = TRUE, na.rm = TRUE) %>% 
    mutate(rf_values = str_remove_all(rf_values, "NA"),
           rf_values = as.numeric(rf_values)) %>% 
    filter(!(samples %in% c("kon_b", "kon_c")))

}
```

#### Classes with identical species from different scans

```{r Sum identical species}
data <- joined_data %>% 
  group_by(class, species, samples, is_intensity, rf_values, standard_input, sample_input) %>% 
  summarise(intensity = sum(intensity)) %>% 
  ungroup
```

# Number crunching

## Apply the Response factor (rf-values) to endogenous intensities

```{r Apply the rf-value}
data <- data %>% 
  mutate(intensity = intensity * rf_values) %>% 
  select(-rf_values)
```

## Quantify lipid species

#### Convert intensities to picomoles

```{r [intensities] to [pmol]}
data <- data %>% 
  mutate(pmol = (standard_input/is_intensity)*intensity) %>% 
  select(-is_intensity, -intensity)
```

#### Blank (kon_a) substraction

```{r sample[pmol] - kon_a[pmol]}
# create kon_a variable for better reading
kon_a <- data %>% 
  filter(samples == "kon_a") %>%  
  select(class, species, kon_a_pmol = pmol)

data <- left_join(data, kon_a, by = c("class", "species")) %>% 
  mutate(pmol_corr = pmol - kon_a_pmol,
         pmol_corr = ifelse(pmol_corr < 0, 0, pmol_corr)) %>% 
  filter(!str_detect(samples, "kon_a")) %>% 
  select(-kon_a_pmol)
```

#### Convert picomoles to micromolar

```{r [pmol] to [uM]}
data <- data %>% 
  mutate(uM = pmol_corr / sample_input)
```

# Create the Excel workbook

## Prepare Excel workbook

```{r Create Excel wb and set font}
wb <- createWorkbook()
modifyBaseFont(wb, fontSize = 10, fontColour = "black", fontName = "Arial")

lipid_class <- unique(data$class)

for (f in lipid_class) {
  
  addWorksheet(wb, f)
  setColWidths(wb, f, col=1 , widths = 20)
  setRowHeights(wb, f, rows = 2, heights = 50)

  excel_sum_data <- data %>% 
    filter(class == f) %>% 
    select(-species) %>% 
    group_by(samples, standard_input,sample_input) %>% 
    summarise("[pmol] before blank sub" = sum(pmol),
              "[pmol] after blank sub" = sum(pmol_corr),
              "[uM]" = sum(uM))
  
  
  excel_species_profile <- data %>% 
    filter(class == f) %>%
    group_by(class, samples) %>% 
    mutate(uM_sum = sum(uM)) %>% 
    mutate(mol_percent = uM*100 / sum(uM)) %>% 
    ungroup %>% 
    select(samples,species, mol_percent) %>% 
    pivot_wider(names_from = species,
                values_from = mol_percent)
  

  species_profile_plot <- data %>% 
    filter(class == f) %>%
    group_by(class, samples) %>% 
    mutate(uM_sum = sum(uM)) %>% 
    mutate(mol_percent = uM*100 / sum(uM)) %>%
    ggplot(aes(x = species, 
               y = mol_percent, 
               fill = samples)) +
    geom_col(position=position_dodge())
    print(species_profile_plot)  
    
  writeData(wb, f, as.character(files[f]), startCol = 1, startRow = 1)
  writeData(wb, f, excel_sum_data, startCol = 2, startRow = 2, rowNames = FALSE)
  writeData(wb, f, as.character(paste0(f, " mol%")), startCol = 1, startRow = (nrow(excel_sum_data)+5))
  writeData(wb, f, excel_species_profile, startCol = 1, startRow = (nrow(excel_sum_data)+6))
  insertPlot(wb, f, width = 5, height = 3.5, fileType = "png", units = "in",startRow = (nrow(excel_sum_data)+nrow(excel_species_profile)))
}

saveWorkbook(wb, "test.xlsx", overwrite = TRUE)
```







data %>%
  group_by(class, samples) %>% 
  mutate(uM_sum = sum(uM)) %>% 
  mutate(species_profile = uM*100 / sum(uM)) %>%
  ggplot(aes(x = species,
             y = species_profile,
             fill = samples)) +
  geom_col(position=position_dodge())+
  facet_wrap(~class, scales = "free", ncol = 2)




```{r}
dir.create("plots", showWarnings = FALSE)

classes <- unique(data$class)

for (f in classes) {
  plotname <- paste0(f, ".pdf" )
  
  pdf(paste0("plots/", plotname ))
  species_profile_plot <- data %>%
    filter(class == f) %>% 
    mutate(uM_sum = sum(uM)) %>% 
    mutate(species_profile = uM*100 / sum(uM)) %>%
    ggplot(aes(x = species, 
               y = species_profile, 
               fill = samples)) +
    geom_col(position=position_dodge())+
    facet_wrap(~class, scales = "free", ncol = 2)
    print(species_profile_plot)
    dev.off()
}
```











